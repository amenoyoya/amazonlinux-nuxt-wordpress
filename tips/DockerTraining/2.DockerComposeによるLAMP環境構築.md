# DockerComposeのインストール
DockerCompose
: Dockerにおける複数コンテナの管理を容易にするツール

```sh
# CoreOSの  /usr/bin/ はRead-Onlyなため /opt/bin/ を作成する
$ sudo mkdir -p /opt/bin

# 念のため ＄PATHを確認しておく
$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/opt/bin

# githubからdocker-composeの最新版をダウンロード
# 最新バージョンは https://github.com/docker/compose/releases/latest/ で確認できる
$ sudo curl -L https://github.com/docker/compose/releases/download/1.24.0/docker-compose-`uname -s`-`uname -m` -o /opt/bin/docker-compose

# docker-composeコマンドの実行を許可
$ sudo chmod +x /opt/bin/docker-compose

# バージョン確認
$ docker-compose -v
docker-compose version 1.24.0, build 0aa59064
```

---

# 最小限のApache環境構築

Apache + PHP7 のコンテナのみで最小限の環境を構築する

## 各種設定ファイルの準備

`.\share`に`docker-php`フォルダを作成し、以下のような構成とする（`1-php-apache`フォルダを参考に）
```ini
share/
`- docker-php/
    |- html/  # コンテナの /var/www/html にマウントされるフォルダ
    |  `- index.php
    |- php/  # PHPサービスコンテナのビルド用フォルダ
    |  |- Dockerfile  # PHPイメージのビルド手順
    |  `- php.ini  # PHPの設定ファイル
    `- docker-compose.yml  # DockerComposeの設定ファイル
```
- `html/index.php`
  ```php
  <?php phpinfo() ?>
  ```
- `php/Dockerfile`
  ```ruby
  # php7とApacheがパックされたイメージを使う
  FROM php:7-apache

  # .\share\docker-php\php\php.ini を コンテナの /usr/local/etc/php/ ディレクトリにコピー
  COPY ./php.ini /usr/local/etc/php/
  ```
- `php/php.ini`
  ```ini
  # PHPの環境を日本語に最適化するための設定
  [Date]
  date.timezone = "Asia/Tokyo"
  [mbstring]
  mbstring.internal_encoding = "UTF-8"
  mbstring.language = "Japanese"
  ```
- `docker-compose.yml`
  ```yaml
  version: '2' # composeファイルバージョン
  services:
    php: # 必要なのはPHP(+Apache)サービス用のコンテナのみ
      build: ./php # php/Dockerfileからビルド
      container_name: php-apache # コンテナ名を"php-apache"に
      ports:
        - '80:80' # ホスト(CoreOS)80番ポートとゲスト(PHPコンテナ)80番ポートをつなぐ
      volumes:
        # ホスト(CoreOS)の ./html とゲスト(PHPコンテナ)の /var/www/html をつなぐ
        # Vagrantの設定により、Windows://.\share\ = CoreOS://~/share/
        # => Windows側からPHPコンテナのドキュメントルートにアクセス可
        - ./html:/var/www/html
  ```

### docker-compose.ymlについて
docker-compose.yml
: 使うコンテナやパラメータなどを記述した設定ファイル。**YAML形式のためインデントに注意！**

#### 基本的な書き方
```yaml
version: '2' # composeファイルバージョン
services: # services以下に起動するコンテナ(サービス)の設定を記述していく
  コンテナ1:
    # コンテナのベースイメージを image or build で指定
    image: imagename # Docker公式イメージをそのままベースイメージにする場合の書き方
    build: ./path    # ./path/Dockerfileからビルド(公式イメージをカスタマイズ)するときの書き方
```

<br>

### Dockerfileについて
Dockerfile
: 公開されているDockerイメージをそのまま使うのではなく、必要なパッケージやアプリ、各種設定を含んだDockerイメージを自分で作成して使用する場合に記述するビルド手順書

#### 基本的な書き方
```ruby
# FROM: どのイメージを基にするか
FROM centos

# MAINTAINER: 作成したユーザの情報
MAINTAINER Admin <admin@admin.com>

# RUN: docker buildするときに実行される
RUN echo "now building..." && \ # \ で複数行記述可能
    curl -SL http://example.com/postgres-$PG_VERSION.tar.xz | tar -xJC /usr/src/postgress

# CMD: docker runするときに実行される
CMD echo "now running..."

# COPY: ホスト側のファイルをコンテナ内にコピー
COPY ./php.ini /usr/local/etc/php/

# EXPOSE: コンテナが接続用にリッスンするポートを指定
## docker-compose.yml でも指定可能
EXPOSE 80

# ENV: コンテナ内の環境変数を更新
## docker-compose.yml でも指定可能
ENV PATH /usr/local/postgres-$PG_MAJOR/bin:$PATH
```

<br>

## DockerComposeを使ってDocker環境起動
```sh
# docker-compose.yml のあるディレクトリに移動
$ cd ~/share/docker-php

# docker-compose.yml で定義したコンテナを自動的に起動
## -dオプションをつけるとバッググラウンドでサービス開始
## --buildオプションを付けるとイメージをビルドしながら起動（初回起動時は付けなくてもビルドされる）
$ docker-compose up -d --build

# 起動中のコンテナを一覧表示
$ docker-compose ps
    Name                  Command               State          Ports
---------------------------------------------------------------------------
php-apache        docker-php-entrypoint apac ...   Up      0.0.0.0:80->80/tcp
```

Windowsホスト側のブラウザに戻り、`http://192.168.56.101`（`ifconfig`コマンドで確認した`eth1`のIP）にアクセスし、`phpinfo()`の内容が表示されていることを確認する

---

# LAMP環境の構築
DockerComposeを用いて、LAMP環境に必要な複数のコンテナを自動的に構築する

- `.\share`に`docker-lamp`フォルダを作成し、以下のような構成とする（`2-lamp`フォルダを参考に）
  ```ini
  share/
  `- docker-lamp/
      |- html/
      |  `- index.php
      |- mysql/  # MySQLサービスコンテナのビルド用フォルダ
      |  |- Dockerfile  # MySQLイメージのビルド手順
      |  `- my.cnf  # MySQLの設定ファイル
      |- php/
      |  |- Dockerfile
      |  `- php.ini
      `- docker-compose.yml
  ```
  - `docker-compose.yml`
    ```yaml
    version: '2' # composeファイルバージョン
    services:
      # MySQLデータ格納ボリューム用のコンテナ
      ## 永続的なデータをコンテナ間で共有したい場合や非永続コンテナから使用したい場合、DataVolumeContainerを作成し、そこからデータをマウントするのが良い
      mysqldata:
        image: busybox # ベースイメージにbusybox(OSの最低限の機能を詰め込んだ万能コマンド)を利用
        container_name: docker-mysqldata # コンテナ名を"docker-mysqldata"に
        volumes:
          - /var/lib/mysql # ボリュームを /var/lib/mysql ディレクトリに設定
      # MySQLサービス用のコンテナ
      mysql:
        build: ./mysql # ./mysql/Dockerfile の内容をもとにイメージをビルド
        container_name: docker-mysql # コンテナ名を"docker-mysql"に
        environment:
          MYSQL_ROOT_PASSWORD: pass # MySQLルートパスワードを"pass"に
        volumes_from:
          - mysqldata # mysqldataコンテナからボリュームをマウント
      # PHPサービス用のコンテナ
      php:
        build: ./php # ./php/Dockerfile の内容をもとにイメージをビルド
        container_name: docker-php # コンテナ名を"docker-php"に
        ports:
          - '80:80' # ホスト(CoreOS)側のポート80番とコンテナ側のポート80番を結ぶ
        volumes:
          - ./html:/var/www/html # ホスト(CoreOS)側の ./html ディレクトリをコンテナ側のドキュメントルート /var/www/html にマウント
        depends_on:
          - mysql # PHPサービスがMySQLサービスに依存していることを示す
    ```
  - その他ファイルは、`2-lamp`フォルダ内のものを参照
- DockerComposeでビルド＆起動
  ```sh
  # docker-compose.yml のあるディレクトリに移動
  $ cd ~/share/docker-lamp

  # DockerComposeでLAMP環境構築＆起動
  $ docker-compose up -d --build

  # 起動しているコンテナを確認
  $ docker-compose ps
          Name                    Command               State           Ports
  --------------------------------------------------------------------------------
  docker-mysql       docker-entrypoint.sh mysqld      Up       3306/tcp, 33060/tcp
  docker-mysqldata   sh                               Exit 0
  docker-php         docker-php-entrypoint apac ...   Up       0.0.0.0:80->80/tcp
  ```

---

# DockerCompose基本コマンド
- `docker-compose up`
    - 設定されたコンテナを自動的にビルドして起動
    - `-d`オプションを使うとバックグラウンド実行可能
    - `--build`オプションを使うとビルドし直してから起動
- `docker-compose down`
    - 起動しているコンテナを全て停止し、コンテナを削除する
    - `--rmi all`オプションを使うとイメージもまとめて削除する
- `docker-compose start`
    - 設定されたコンテナを起動（ビルド済みのコンテナのみ）
- `docker-compose stop`
	- 起動しているコンテナをすべて停止
- `docker-compose restart`
    - 起動しているコンテナを全て再起動
- `docker-compose ps`
    - 起動しているコンテナを一覧表示
- `docker-compose exec <サービス名> <コマンド>`
    - 指定したDockerサービス内のコマンドを実行する
    - `docker exec -it <コンテナ名> <コマンド>` と同じ動作をするが、コンテナ名（`docker-compose ps`で一覧に出てくる名前）ではなく、サービス名（`docker-compose.yml`で定義した名前）を指定することに注意